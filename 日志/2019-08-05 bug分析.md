## 图片上传失败, 返回状态码405
> 今天早上qa过来找我, 反馈 开机广告中图片资源上传失败, 经过分析和goole, 结果是 用post方法请求静态资源, 在nginx中会返回405

### 查找分析过程
1. 第一反应怀疑是公共的上传组建有问题, 但是国际和国内使用上传组建相同, 且国内正常, 排除
2. 通过比对成功上传的请求, 发现上传成功的请求都会向服务端发送一个get请求, 获取静态资源, response状态是**200 OK (from disk cache)**或**304**, 都是[获取的缓存资源](https://www.jianshu.com/p/54cc04190252); 而上传失败的请求向服务端发送的是一个post请求, 请求方式的不同没有重视, 而是怀疑缓存资源获取失败, 导致的请求失败
3. 继续查看失败请求的reponse, 发现是nginx报错, 然后在谦姐的帮助下解决来问题 [解决方法](https://blog.51cto.com/chinahao/2057940)

### 复盘
1. 啥图片上传时 需要重新请求一次静态资源 (猜想是apollo的特性,未验证)
2. 为啥上传成功是get请求, 而上传失败是post请求
 * 使用 **chrome://net-export/** 来捕获请求过程, 生成json文件
 * 使用 **https://netlog-viewer.appspot.com/#import** 来解析生成的文件
 * 对正常的上传请求 生成的json文件 进行解析生成网页
 ![](http://img.blog.liuyingfeng.com/js-20190805-1.jpg)
 * 切换至events
 ![](http://img.blog.liuyingfeng.com/js-20190805-2.jpg)
 ![](http://img.blog.liuyingfeng.com/js-20190805-3.jpg)
 可以清晰的看到, 有两次请求, 开始是一次post请求, 但是返回的是301, 进行了[永久重定向](https://www.cnblogs.com/zhuzhenwei918/p/7582620.html); 然后才是get请求; 既然通过这可以看出进行了2次请求, 那chrome中network也应该可以查看到, 但是为啥正常请求只展示了get请求,而没有看到post请求
 ![](http://img.blog.liuyingfeng.com/js-20190805-4.jpg)
 ![](http://img.blog.liuyingfeng.com/js-20190805-5.jpg)
 一直打开的xhr, 重定向的请求 没有展示; 改成all, 才会展示 重定向的请求, 自己埋下的坑, 惨
3. 为什么会进行重定向
  * 比对 请求头中 url 和 响应头中 location; 只有 一个后缀 '/'的区别, 导致了重定向
  ![](http://img.blog.liuyingfeng.com/js-20190805-6.jpg)
  * 不带后缀'/', 强制刷新会重定向; 带后缀 '/', 强制刷新不会重定向
  ![](http://img.blog.liuyingfeng.com/js-20190805-7.jpg)



